<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>주문 상세 정보 팝업</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: rgba(0, 0, 0, 0.5); /* 배경 어둡게 */
            display: flex;
            justify-content: center;
            align-items: center; /* 수직 중앙 정렬 */
            min-height: 100vh;
            padding: 20px; /* 모바일에서 좌우 여백 확보 */
            margin: 0;
            box-sizing: border-box;
        }

        .popup-container {
            width: 100%;
            /* 모바일 최적화: 좌우 여백을 고려한 너비 설정 */
            max-width: 420px; 
            background-color: #fff;
            border-radius: 12px; /* 둥근 모서리 약간 강화 */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            position: relative;
            /* 기본 상태: 화면 높이에 맞춰 스크롤 생성 */
            max-height: calc(100vh - 40px); 
        }
        
        /* 스크롤 영역 */
        .scrollable-content {
            flex-grow: 1;
            overflow-y: auto;
            /* 스크롤바 숨기기 (선택 사항) */
            scrollbar-width: thin;
            padding-bottom: 20px;
        }

        /* 하단 고정 액션 바 */
        .fixed-footer {
            flex-shrink: 0;
            position: sticky;
            bottom: 0;
            z-index: 10;
            border-top: 1px solid #e5e7eb;
            background-color: #fff;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem; 
            font-size: 0.75rem; 
            font-weight: 700; 
            border-radius: 9999px; /* 완전 둥근 뱃지 */
        }
        .status-delivery-complete { background-color: #ecfdf5; color: #047857; } 

        .price-xs { font-size: 0.75rem; letter-spacing: -0.025em; }
        .price-xxs { font-size: 0.7rem; letter-spacing: -0.035em; }

        /* --- [핵심 수정] 캡처 모드 스타일 --- */
        /* 캡처 시 팝업을 전체 내용을 담도록 확장하고 스타일을 재정의 */
        .popup-container.capture-mode {
            position: absolute; /* 화면 중앙 정렬 등의 제약을 벗어남 */
            top: 0;
            left: 0;
            width: 420px !important; /* 이미지 너비 고정 (일관성) */
            max-width: none !important;
            height: auto !important;
            max-height: none !important;
            border-radius: 0; /* 영수증처럼 보이게 모서리 직각 처리 (선택) */
            box-shadow: none;
            overflow: visible !important;
            z-index: 9999;
            margin: 0;
            transform: none;
        }

        .popup-container.capture-mode .scrollable-content {
            overflow: visible !important;
            height: auto !important;
            padding-bottom: 40px; /* 하단 여백 추가 */
        }

        /* 캡처 시 숨길 요소들 (닫기 버튼, 하단 고정 버튼 등) */
        .popup-container.capture-mode .no-capture {
            display: none !important;
        }

        /* 공유 모달 스타일 */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.75);
            transition: opacity 0.3s ease;
        }
        
        /* 로딩 스피너 */
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid #10b981; /* 녹색 */
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="popup-container" id="receipt-popup">
        
        <!-- [닫기 버튼] 캡처 시 숨김 처리 (.no-capture) -->
        <button onclick="closePopup()" class="no-capture absolute top-3 right-3 text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100 transition z-20">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        
        <!-- 로고 섹션 -->
        <div class="p-5 border-b border-gray-100 bg-white text-center flex-shrink-0">
            <div class="text-2xl font-extrabold text-green-600 tracking-wider">ORDERZ</div>
        </div>

        <!-- 스크롤 가능한 본문 영역 -->
        <div class="scrollable-content">
            
            <!-- 헤더: 주문번호, 배송일 -->
            <div class="p-5 bg-gray-50 border-b border-gray-100 flex items-start justify-between">
                <div class="flex-shrink-0">
                    <div class="text-sm mb-1.5 flex items-center">
                        <span class="text-gray-500 w-16 inline-block">주문번호</span>
                        <span class="font-bold text-gray-800">20251022-1234567</span>
                    </div>
                    <div class="text-sm flex items-center">
                        <span class="text-gray-500 w-16 inline-block">배송일</span>
                        <span class="font-bold text-gray-800">2025-10-25</span>
                    </div>
                </div>
                <div class="flex-shrink-0 mt-1">
                    <span class="status-badge status-delivery-complete">
                        배송 완료
                    </span>
                </div>
            </div>

            <!-- 주문 내역 -->
            <div class="p-5">
                <h3 class="text-base font-bold text-gray-800 mb-3">주문 내역</h3>

                <!-- 컬럼 헤더 -->
                <div class="grid grid-cols-[5fr_1fr_2fr_3fr] gap-2 text-xs font-medium text-gray-400 border-b border-gray-200 pb-2 mb-2">
                    <span>상품정보</span>
                    <span class="text-center">수량</span>
                    <span class="text-right">단가</span>
                    <span class="text-right">합계</span>
                </div>

                <!-- 상품 리스트 -->
                <div class="space-y-3" id="order-items-list">
                    <!-- 상품 1 -->
                    <div class="grid grid-cols-[5fr_1fr_2fr_3fr] gap-2 text-sm items-center">
                        <span class="text-gray-800 font-medium truncate">대파(단)</span>
                        <span class="text-center text-gray-600">700</span>
                        <span class="text-right text-gray-500 price-cell" data-price="3500">3,500</span>
                        <span class="text-right font-bold text-gray-800 price-cell" data-price="2450000">2,450,000</span>
                    </div>
                    <!-- 상품 2 -->
                    <div class="grid grid-cols-[5fr_1fr_2fr_3fr] gap-2 text-sm items-center">
                        <span class="text-gray-800 font-medium truncate">깐양파_10kg</span>
                        <span class="text-center text-gray-600">1</span>
                        <span class="text-right text-gray-500 price-cell" data-price="20600">20,600</span>
                        <span class="text-right font-bold text-gray-800 price-cell" data-price="20600">20,600</span>
                    </div>
                    <!-- 상품 3 -->
                    <div class="grid grid-cols-[5fr_1fr_2fr_3fr] gap-2 text-sm items-center">
                        <span class="text-gray-800 font-medium truncate">백다다기_5개입</span>
                        <span class="text-center text-gray-600">1</span>
                        <span class="text-right text-gray-500 price-cell" data-price="3600">3,600</span>
                        <span class="text-right font-bold text-gray-800 price-cell" data-price="3600">3,600</span>
                    </div>
                    <!-- 상품 4 -->
                    <div class="grid grid-cols-[5fr_1fr_2fr_3fr] gap-2 text-sm items-center">
                        <span class="text-gray-800 font-medium truncate">양배추(대)</span>
                        <span class="text-center text-gray-600">1</span>
                        <span class="text-right text-gray-500 price-cell" data-price="2700">2,700</span>
                        <span class="text-right font-bold text-gray-800 price-cell" data-price="2700">2,700</span>
                    </div>
                    <!-- 상품 5 -->
                    <div class="grid grid-cols-[5fr_1fr_2fr_3fr] gap-2 text-sm items-center">
                        <span class="text-gray-800 font-medium truncate">무순/중(150g)</span>
                        <span class="text-center text-gray-600">1</span>
                        <span class="text-right text-gray-500 price-cell" data-price="1300">1,300</span>
                        <span class="text-right font-bold text-gray-800 price-cell" data-price="1300">1,300</span>
                    </div>
                    <!-- 상품 6 -->
                    <div class="grid grid-cols-[5fr_1fr_2fr_3fr] gap-2 text-sm items-center">
                        <span class="text-gray-800 font-medium truncate">가리비관자 500g</span>
                        <span class="text-center text-gray-600">1</span>
                        <span class="text-right text-gray-500 price-cell" data-price="6800">6,800</span>
                        <span class="text-right font-bold text-gray-800 price-cell" data-price="6800">6,800</span>
                    </div>
                    <!-- 상품 7 -->
                    <div class="grid grid-cols-[5fr_1fr_2fr_3fr] gap-2 text-sm items-center">
                        <span class="text-gray-800 font-medium truncate">칵테일새우 31/50</span>
                        <span class="text-center text-gray-600">2</span>
                        <span class="text-right text-gray-500 price-cell" data-price="4100">4,100</span>
                        <span class="text-right font-bold text-gray-800 price-cell" data-price="8200">8,200</span>
                    </div>
                    <!-- 상품 8 -->
                    <div class="grid grid-cols-[5fr_1fr_2fr_3fr] gap-2 text-sm items-center">
                        <span class="text-gray-800 font-medium truncate">솔방울오징어</span>
                        <span class="text-center text-gray-600">2</span>
                        <span class="text-right text-gray-500 price-cell" data-price="2100">2,100</span>
                        <span class="text-right font-bold text-gray-800 price-cell" data-price="4200">4,200</span>
                    </div>
                    <!-- 상품 9 -->
                    <div class="grid grid-cols-[5fr_1fr_2fr_3fr] gap-2 text-sm items-center">
                        <span class="text-gray-800 font-medium truncate">냉동자숙피홍합</span>
                        <span class="text-center text-gray-600">1</span>
                        <span class="text-right text-gray-500 price-cell" data-price="3300">3,300</span>
                        <span class="text-right font-bold text-gray-800 price-cell" data-price="3300">3,300</span>
                    </div>
                    <!-- 상품 10 -->
                    <div class="grid grid-cols-[5fr_1fr_2fr_3fr] gap-2 text-sm items-center">
                        <span class="text-gray-800 font-medium truncate">성게알 A급</span>
                        <span class="text-center text-gray-600">1</span>
                        <span class="text-right text-gray-500 price-cell" data-price="15100">15,100</span>
                        <span class="text-right font-bold text-gray-800 price-cell" data-price="15100">15,100</span>
                    </div>
                    <!-- 상품 11 -->
                    <div class="grid grid-cols-[5fr_1fr_2fr_3fr] gap-2 text-sm items-center">
                        <span class="text-gray-800 font-medium truncate">감자샐러드(MDS)</span>
                        <span class="text-center text-gray-600">4</span>
                        <span class="text-right text-gray-500 price-cell" data-price="6500">6,500</span>
                        <span class="text-right font-bold text-gray-800 price-cell" data-price="26000">26,000</span>
                    </div>
                     <!-- 상품 12 -->
                     <div class="grid grid-cols-[5fr_1fr_2fr_3fr] gap-2 text-sm items-center">
                        <span class="text-gray-800 font-medium truncate">올리브오일</span>
                        <span class="text-center text-gray-600">1</span>
                        <span class="text-right text-gray-500 price-cell" data-price="18800">18,800</span>
                        <span class="text-right font-bold text-gray-800 price-cell" data-price="18800">18,800</span>
                    </div>
                     <!-- 상품 13 -->
                     <div class="grid grid-cols-[5fr_1fr_2fr_3fr] gap-2 text-sm items-center">
                        <span class="text-gray-800 font-medium truncate">DB휘핑크림</span>
                        <span class="text-center text-gray-600">2</span>
                        <span class="text-right text-gray-500 price-cell" data-price="5100">5,100</span>
                        <span class="text-right font-bold text-gray-800 price-cell" data-price="10200">10,200</span>
                    </div>
                    <!-- 상품 14 -->
                    <div class="grid grid-cols-[5fr_1fr_2fr_3fr] gap-2 text-sm items-center">
                        <span class="text-gray-800 font-medium truncate">레몬_10입</span>
                        <span class="text-center text-gray-600">1</span>
                        <span class="text-right text-gray-500 price-cell" data-price="3400">3,400</span>
                        <span class="text-right font-bold text-gray-800 price-cell" data-price="3400">3,400</span>
                    </div>
                </div>
                
                <!-- 결제 요약 -->
                <div class="mt-6 pt-4 border-t-2 border-dashed border-gray-200 space-y-2 text-sm">
                    
                    <div class="flex justify-between items-center text-gray-800">
                        <span class="font-medium">최종 상품 합계</span>
                        <span id="final-total" class="font-bold price-cell" data-price="2567800">2,567,800</span>
                    </div>
                    
                    <div class="flex justify-between items-center text-gray-500">
                        <span>쿠폰 할인</span>
                        <span class="price-cell" data-price="5000">-5,000</span>
                    </div>
                    <div class="flex justify-between items-center text-gray-500">
                        <span>포인트 사용</span>
                        <span class="price-cell" data-price="3000">-3,000P</span>
                    </div>
                    
                    <div class="flex justify-between items-center text-gray-800 mt-2">
                        <span class="font-medium">입금 금액</span>
                        <span id="deposit-amount" class="font-bold price-cell" data-price="2562800">2,562,800</span>
                    </div>
                    
                    <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-100">
                        <span class="font-bold text-gray-900 text-base">최종 잔액</span>
                        <span class="text-red-500 font-bold text-lg price-cell" data-price="3000">-3,000</span>
                    </div>
                </div>
            </div>
            <!-- 영수증 끝 메시지 (캡처 시에만 보일 수 있음) -->
            <div class="text-center pb-4 text-xs text-gray-300 tracking-widest uppercase">
                End of Receipt
            </div>
        </div>

        <!-- 하단 고정 액션 바: 캡처 시 숨김 처리 (.no-capture) -->
        <div class="fixed-footer flex no-capture">
            <button id="capture-share-btn" onclick="captureReceiptAndShare()" class="w-full p-4 text-base font-bold text-white bg-green-600 hover:bg-green-700 transition duration-150 flex items-center justify-center space-x-2">
                <span id="capture-btn-text">전체 내역 캡처 및 공유</span>
                <div id="capture-spinner" class="spinner hidden"></div>
            </button>
        </div>
    </div>

    <!-- 공유 방식 선택 모달 -->
    <div id="share-modal-overlay" onclick="hideShareModal()" class="modal-overlay hidden fixed inset-0 z-50 flex justify-center items-center opacity-0 p-4">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-xs transform transition-transform duration-300 scale-95" id="share-modal-content" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold mb-4 text-center text-gray-800">이미지 저장 및 공유</h3>
            <p class="text-sm text-center text-gray-500 mb-6">
                전체 주문 내역이 이미지로 생성되었습니다.<br>아래 버튼을 눌러 저장하세요.
            </p>
            <div class="space-y-3">
                <button onclick="downloadCapturedImage()" class="w-full py-3.5 text-base font-bold text-white bg-green-600 rounded-xl hover:bg-green-700 transition flex items-center justify-center space-x-2 shadow-lg shadow-green-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    <span>이미지 다운로드</span>
                </button>
                <button onclick="copyCapturedImageLink()" id="copy-link-btn" class="w-full py-3.5 text-base font-bold text-gray-700 bg-gray-100 rounded-xl hover:bg-gray-200 transition flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
                    </svg>
                    <span id="copy-link-text">이미지 링크 복사</span>
                </button>
            </div>
            <button onclick="hideShareModal()" class="w-full mt-4 py-3 text-sm font-medium text-gray-400 hover:text-gray-600 transition">
                닫기
            </button>
        </div>
    </div>

    <script>
        let capturedImageDataUrl = null;

        // 가격 포맷팅 및 상품 수량 계산
        function formatPriceAndCount() {
            // 가격 포맷팅
            document.querySelectorAll('.price-cell').forEach(cell => {
                const price = parseInt(cell.dataset.price, 10);
                if (isNaN(price)) return;
                
                const originalText = cell.textContent || "";
                const isNegative = originalText.startsWith('-') || cell.classList.contains('text-red-500');
                const isPoints = originalText.endsWith('P');

                const formattedNumber = price.toLocaleString('ko-KR');
                
                let prefix = isNegative && price > 0 ? '-' : '';
                let suffix = isPoints ? 'P' : '원';

                cell.textContent = prefix + formattedNumber + suffix;
                
                // 단가 셀 폰트 사이즈 조정
                if (cell.classList.contains('text-gray-500')) {
                    if (price >= 10000) cell.classList.add('price-xxs');
                    else cell.classList.add('price-xs');
                }
            });

            // 상품 건수/개수 계산
            try {
                const itemList = document.getElementById('order-items-list');
                const items = itemList.querySelectorAll('.grid');
                const itemCount = items.length;
                let totalQuantity = 0;
                
                items.forEach(itemGrid => {
                    const quantitySpan = itemGrid.querySelectorAll('span')[1];
                    if (quantitySpan) {
                        const quantity = parseInt(quantitySpan.textContent, 10);
                        if (!isNaN(quantity)) totalQuantity += quantity;
                    }
                });
                
                const finalTotalSpan = document.getElementById('final-total');
                if (finalTotalSpan && finalTotalSpan.previousElementSibling) {
                    finalTotalSpan.previousElementSibling.textContent = `최종 상품 합계 (${itemCount}건 / ${totalQuantity}개)`;
                }
            } catch (e) {
                console.error("수량 계산 오류:", e);
            }
        }

        // --- 캡처 로직 (핵심 수정) ---
        async function captureReceiptAndShare() {
            showLoading();
            const popupElement = document.getElementById('receipt-popup');
            
            // 1. 현재 스크롤 위치 저장 및 최상단 이동
            const originalScrollPos = window.scrollY;
            window.scrollTo(0, 0);

            // 2. 캡처 모드 클래스 추가 (높이 제한 해제, 절대 위치로 변경 등)
            popupElement.classList.add('capture-mode');
            document.body.style.overflow = 'hidden'; // 캡처 중 배경 스크롤 방지

            try {
                // 3. html2canvas로 전체 캡처
                // scale: 2 (고해상도), scrollY: 0 (스크롤 위치 초기화 상태에서 캡처)
                const canvas = await html2canvas(popupElement, {
                    scale: 2, 
                    useCORS: true,
                    backgroundColor: '#ffffff', // 투명 배경 방지
                    scrollY: 0,
                    windowWidth: document.documentElement.offsetWidth,
                    windowHeight: document.documentElement.scrollHeight
                });

                capturedImageDataUrl = canvas.toDataURL('image/png');
                const file = dataURLtoFile(capturedImageDataUrl, 'Order_Receipt.png');
                
                if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        title: '주문 상세 영수증',
                        text: '주문 내역을 공유합니다.',
                        files: [file],
                    });
                } else {
                    showShareModal();
                }

            } catch (err) {
                console.error('캡처 실패:', err);
                alert("이미지 생성에 실패했습니다.");
            } finally {
                // 4. 원래 상태로 복구
                popupElement.classList.remove('capture-mode');
                document.body.style.overflow = '';
                window.scrollTo(0, originalScrollPos);
                hideLoading();
            }
        }

        // --- 기타 유틸리티 함수들 ---
        function dataURLtoFile(dataurl, filename) {
            let arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
            while(n--) u8arr[n] = bstr.charCodeAt(n);
            return new File([u8arr], filename, {type:mime});
        }

        function closePopup() {
            if (window.opener) window.close();
            else alert("팝업 닫기 (실제 구현 시 창 닫힘)");
        }

        function showShareModal() {
            const modal = document.getElementById('share-modal-overlay');
            const content = document.getElementById('share-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); content.classList.remove('scale-95'); }, 10);
        }

        function hideShareModal() {
            const modal = document.getElementById('share-modal-overlay');
            const content = document.getElementById('share-modal-content');
            modal.classList.add('opacity-0'); content.classList.add('scale-95');
            setTimeout(() => { 
                modal.classList.add('hidden'); 
                document.getElementById('copy-link-text').textContent = '이미지 링크 복사';
                document.getElementById('copy-link-btn').classList.replace('bg-green-100', 'bg-gray-100');
            }, 300);
        }

        function showLoading() {
            document.getElementById('capture-btn-text').classList.add('hidden');
            document.getElementById('capture-spinner').classList.remove('hidden');
            document.getElementById('capture-share-btn').disabled = true;
        }

        function hideLoading() {
            document.getElementById('capture-btn-text').classList.remove('hidden');
            document.getElementById('capture-spinner').classList.add('hidden');
            document.getElementById('capture-share-btn').disabled = false;
        }

        function downloadCapturedImage() {
            if (!capturedImageDataUrl) return;
            const link = document.createElement('a');
            link.href = capturedImageDataUrl;
            link.download = 'Order_Receipt.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            hideShareModal();
        }

        function copyCapturedImageLink() {
            // 이미지 데이터를 클립보드에 복사 (가능한 경우 이미지 자체, 아니면 링크)
            if (!capturedImageDataUrl) return;
            
            try {
                // Clipboard API로 이미지 자체 복사 시도
                fetch(capturedImageDataUrl)
                .then(res => res.blob())
                .then(blob => {
                    const item = new ClipboardItem({ 'image/png': blob });
                    navigator.clipboard.write([item]).then(() => {
                        const btnText = document.getElementById('copy-link-text');
                        btnText.textContent = '이미지 복사 완료!';
                    }).catch(err => {
                        // 실패 시 기존 텍스트박스 방식 사용
                        console.warn("이미지 직접 복사 실패, 텍스트로 시도", err);
                        fallbackCopyText();
                    });
                });
            } catch (err) {
                fallbackCopyText();
            }
        }
        
        function fallbackCopyText() {
            const textArea = document.createElement('textarea');
            textArea.value = capturedImageDataUrl;
            textArea.style.position = 'fixed'; 
            textArea.style.opacity = 0;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            const btnText = document.getElementById('copy-link-text');
            btnText.textContent = '링크 복사 완료!';
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', formatPriceAndCount);
    </script>
</body>
</html>
