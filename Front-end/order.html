<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전용몰 주문서 (최종 통합본)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .payment-label {
            transition: all 0.2s ease-in-out;
        }
        input[type="radio"]:checked + .payment-label {
            border-color: #14b8a6;
            background-color: #f0fdfa;
            color: #0d9488;
            font-weight: 600;
            box-shadow: 0 0 0 2px #14b8a6;
        }
        .custom-checkbox:checked {
            background-color: #2dd4bf;
            border-color: #2dd4bf;
        }
        .custom-checkbox:checked::after {
            content: '✔';
            color: white;
            display: block;
            text-align: center;
            line-height: 1.25rem;
            font-size: 0.8rem;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }
        #bank-info {
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
            padding: 0;
            opacity: 0;
            margin-top: 0;
        }
        #bank-info.show {
            max-height: 200px; /* 충분한 높이 */
            opacity: 1;
            margin-top: 0.5rem; /* mt-2 */
        }
    </style>
</head>
<body class="bg-gray-50">

    <div class="max-w-md mx-auto bg-white">
        <!-- 헤더 -->
        <header class="flex justify-between items-center p-4 border-b">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            <h1 class="text-lg font-bold">주문서 작성</h1>
            <div class="w-6"></div>
        </header>

        <main class="p-4">
            <!-- 배송 정보 -->
            <section>
                <div class="flex justify-between items-center">
                    <h2 class="text-base font-semibold">배송 정보</h2>
                    <button id="toggle-address-btn" class="text-teal-600 text-sm font-medium">변경</button>
                </div>
                <div id="address-summary" class="mt-3 text-sm text-gray-700 p-4 border rounded-lg bg-gray-50/50">
                    <p class="font-bold">우리식당</p>
                    <p class="mt-1">010-1234-5678</p>
                    <p class="mt-1">(51496) 경남 창원시 성산구 가음정로 94, 상세주소</p>
                </div>
                <div id="address-edit" class="accordion-content"></div>
            </section>

            <hr class="my-6">

            <!-- 주문 상품 -->
            <section>
                <h2 class="text-base font-semibold mb-3">주문 상품</h2>
                <div class="border-t border-b">
                    <div class="space-y-2 p-3 text-sm">
                        <div class="flex items-center"><p class="flex-1 text-gray-800">다부리 배숙_4포 자기</p><span class="w-10 text-center">1</span><span class="w-20 text-right font-medium">17,300원</span></div>
                        <div class="flex items-center"><p class="flex-1 text-gray-800">수정과 배숙 스틱 10gx30</p><span class="w-10 text-center">1</span><span class="w-20 text-right font-medium">10,500원</span></div>
                    </div>
                </div>
                <div class="mt-4">
                    <label for="delivery-request-custom" class="text-sm font-medium text-gray-700">전하실 말씀 (배송 요청사항)</label>
                    <input type="text" id="delivery-request-custom" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2" placeholder="전하실 말씀을 입력해주세요.">
                </div>
            </section>
            
            <hr class="my-6">

            <!-- 품절상품 대체 배송 동의 -->
            <section>
                <div class="p-4 border rounded-lg bg-gray-50/50">
                    <div class="flex items-start">
                        <input id="substitute-agreement" type="checkbox" class="h-5 w-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500 mt-1 custom-checkbox appearance-none" checked>
                        <div class="ml-3 text-sm">
                            <label for="substitute-agreement" class="font-medium text-gray-800">품절상품 대체 상품으로 배송 동의</label>
                            <ul class="mt-2 text-xs text-gray-600 list-disc list-inside space-y-1">
                                <li>품절 상품은 가장 유사한 대체상품으로 배송해 드립니다.</li>
                                <li>단가 차액은 예치금 충전 또는 추가 결제 요청드립니다.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <hr class="my-6">
            
            <!-- 결제 정보 -->
            <section>
                <h2 class="text-base font-semibold mb-3">결제 정보</h2>
                
                <div class="p-4 border rounded-lg bg-gray-50 mb-4">
                    <h3 class="font-semibold text-gray-800">여신 현황</h3>
                    <div class="mt-3 space-y-2 text-sm">
                        <div class="flex justify-between"><span>총 한도</span><span id="total-credit-limit"></span></div>
                        <div class="flex justify-between"><span>사용 금액</span><span id="used-credit"></span></div>
                        <div class="flex justify-between text-teal-600"><span class="font-bold">잔여 한도</span><span id="available-credit" class="font-bold"></span></div>
                    </div>
                    <div class="mt-3 w-full bg-gray-200 rounded-full h-2.5"><div id="credit-usage-bar" class="bg-teal-500 h-2.5 rounded-full"></div></div>
                </div>

                <!-- 여신 한도 충분할 때 UI -->
                <div id="payment-sufficient">
                     <h3 class="text-sm font-medium text-gray-700 mb-2">결제 수단</h3>
                     <div class="grid grid-cols-2 gap-2">
                        <div>
                           <input type="radio" name="payment-method" id="pm-credit" value="credit" class="hidden" checked>
                           <label for="pm-credit" class="payment-label flex items-center justify-center p-3 border rounded-lg text-sm cursor-pointer">여신결제</label>
                        </div>
                        <div>
                           <input type="radio" name="payment-method" id="pm-simple" value="simple" class="hidden">
                           <label for="pm-simple" class="payment-label flex items-center justify-center p-3 border rounded-lg text-sm cursor-pointer">간편결제</label>
                        </div>
                        <div>
                           <input type="radio" name="payment-method" id="pm-card" value="card" class="hidden">
                           <label for="pm-card" class="payment-label flex items-center justify-center p-3 border rounded-lg text-sm cursor-pointer">신용카드</label>
                        </div>
                         <div>
                           <input type="radio" name="payment-method" id="pm-vbank" value="vbank" class="hidden">
                           <label for="pm-vbank" class="payment-label flex items-center justify-center p-3 border rounded-lg text-sm cursor-pointer">가상계좌</label>
                        </div>
                    </div>
                </div>

                <!-- 여신 한도 부족할 때 UI -->
                <div id="payment-shortfall" class="hidden">
                    <div class="p-4 border-2 border-orange-300 bg-orange-50 rounded-lg">
                        <h3 class="font-semibold text-orange-800">차액 결제 안내</h3>
                        <p class="text-xs text-orange-700 mt-2">잔여 여신 한도가 부족하여 차액 결제로 진행됩니다.</p>
                        <div class="mt-4 space-y-2 text-sm border-t border-orange-200 pt-3">
                            <div class="flex justify-between"><span>최종 결제 금액</span><span id="shortfall-total" class="font-medium text-gray-700"></span></div>
                            <div class="flex justify-between"><span>여신 사용</span><span id="shortfall-credit-used" class="font-medium text-gray-700"></span></div>
                            <div class="flex justify-between text-orange-800"><span class="font-bold">추가 결제할 금액</span><span id="shortfall-amount" class="font-bold"></span></div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">결제 수단</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                               <input type="radio" name="shortfall-payment" id="sp-vbank" value="vbank" class="hidden" checked>
                               <label for="sp-vbank" class="payment-label flex items-center justify-center p-3 border rounded-lg text-sm cursor-pointer">가상계좌</label>
                            </div>
                            <div>
                               <input type="radio" name="shortfall-payment" id="sp-bank" value="bank" class="hidden">
                               <label for="sp-bank" class="payment-label flex items-center justify-center p-3 border rounded-lg text-sm cursor-pointer">무통장입금</label>
                            </div>
                            <div>
                               <input type="radio" name="shortfall-payment" id="sp-simple" value="simple" class="hidden">
                               <label for="sp-simple" class="payment-label flex items-center justify-center p-3 border rounded-lg text-sm cursor-pointer">간편결제</label>
                            </div>
                            <div>
                               <input type="radio" name="shortfall-payment" id="sp-card" value="card" class="hidden">
                               <label for="sp-card" class="payment-label flex items-center justify-center p-3 border rounded-lg text-sm cursor-pointer">신용카드</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="bank-info" class="bg-gray-50 rounded-md border text-sm">
                    <div class="p-4 space-y-3">
                        <div class="flex justify-between items-center">
                            <p class="text-sm">
                                <span id="bank-account-text" class="font-bold">우리은행 1002-123-456789</span>
                                <span class="text-gray-600 ml-2">(예금주: 이무철)</span>
                            </p>
                            <button onclick="copyToClipboard()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs font-bold py-2 px-3 rounded flex-shrink-0 ml-2">복사</button>
                        </div>
                        <div class="border-t pt-3 flex justify-between items-center">
                            <label for="depositor-name" class="text-sm text-gray-700 flex-shrink-0">입금자명</label>
                            <input type="text" id="depositor-name" value="상호명" class="block w-1/2 rounded-md border-gray-300 shadow-sm p-2 text-sm h-9">
                        </div>
                    </div>
                </div>
                <div id="copy-message" class="text-center text-sm text-teal-600 mt-2 h-5"></div>
            </section>
        </main>

        <footer class="sticky bottom-0 bg-white border-t p-4">
            <div id="footer-summary" class="space-y-2 text-sm mb-4">
                <!-- JS로 동적 생성 -->
            </div>
            
            <div class="flex items-center mb-3">
                <input id="agreement" type="checkbox" class="h-5 w-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500 appearance-none custom-checkbox">
                <label for="agreement" class="ml-2 block text-xs text-gray-700">주문 상품, 가격, 배송 정보를 확인했으며 구매에 동의합니다. (필수)</label>
            </div>
            
            <button id="payment-button" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg transition-colors"></button>
        </footer>
    </div>

    <script>
        // --- 데이터 (서버에서 가져올 정보) ---
        const creditData = { totalLimit: 5000000, used: 4990000 };
        const orderTotal = 27800;
        const shippingFee = 3000;
        const freeShippingThreshold = 50000;
        const bankAccount = '1002-123-456789';

        // --- UI 요소 ---
        const ui = {
            totalCreditLimit: document.getElementById('total-credit-limit'),
            usedCredit: document.getElementById('used-credit'),
            availableCredit: document.getElementById('available-credit'),
            creditUsageBar: document.getElementById('credit-usage-bar'),
            paymentSufficient: document.getElementById('payment-sufficient'),
            paymentShortfall: document.getElementById('payment-shortfall'),
            shortfallTotal: document.getElementById('shortfall-total'),
            shortfallCreditUsed: document.getElementById('shortfall-credit-used'),
            shortfallAmount: document.getElementById('shortfall-amount'),
            bankInfo: document.getElementById('bank-info'),
            copyMessage: document.getElementById('copy-message'),
            footerSummary: document.getElementById('footer-summary'),
            paymentButton: document.getElementById('payment-button'),
        };

        document.addEventListener('DOMContentLoaded', () => {
            initialize();
            document.querySelectorAll('input[name="payment-method"], input[name="shortfall-payment"]').forEach(radio => {
                radio.addEventListener('change', updateSummary);
            });
        });

        function formatCurrency(amount) { return new Intl.NumberFormat('ko-KR').format(amount) + '원'; }

        function initialize() {
            const addressEditForm = `<div class="space-y-3 pt-4"><div><label class="text-sm font-medium text-gray-700">상호명</label><input type="text" value="우리식당" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100"></div><div><label class="text-sm font-medium text-gray-700">휴대폰 번호</label><input type="text" value="010-1234-5678" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100"></div><div><label class="text-sm font-medium text-gray-700">주소</label><div class="flex space-x-2 mt-1"><input type="text" value="51496" class="block w-1/3 rounded-md border-gray-300 shadow-sm p-2 bg-gray-100"><button class="w-2/3 rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">주소검색</button></div><input type="text" value="경남 창원시 성산구 가음정로 94" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm p-2 bg-gray-100"><input type="text" placeholder="상세주소 입력" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm p-2"></div></div>`;
            document.getElementById('address-edit').innerHTML = addressEditForm;
            setupAccordion('toggle-address-btn', 'address-edit', false, document.getElementById('address-summary'));
            updateSummary();
        }

        function updateSummary() {
            const currentShippingFee = orderTotal < freeShippingThreshold ? shippingFee : 0;
            const finalAmount = orderTotal + currentShippingFee;
            const availableCredit = creditData.totalLimit - creditData.used;
            const usagePercentage = (creditData.used / creditData.totalLimit) * 100;

            ui.totalCreditLimit.textContent = formatCurrency(creditData.totalLimit);
            ui.usedCredit.textContent = formatCurrency(creditData.used);
            ui.availableCredit.textContent = formatCurrency(availableCredit);
            ui.creditUsageBar.style.width = `${usagePercentage}%`;

            if (finalAmount <= availableCredit) {
                ui.paymentSufficient.classList.remove('hidden');
                ui.paymentShortfall.classList.add('hidden');
                const selectedPayment = document.querySelector('input[name="payment-method"]:checked').value;
                
                ui.bankInfo.classList.toggle('show', selectedPayment === 'vbank' || selectedPayment === 'bank');

                let summaryHtml = `<div class="flex justify-between"><span class="text-gray-600">총 상품금액</span><span>${formatCurrency(orderTotal)}</span></div><div class="flex justify-between"><span class="text-gray-600">배송비</span><span>${formatCurrency(currentShippingFee)}</span></div><hr class="my-2 !m-0">`;
                
                if (selectedPayment === 'credit') {
                    const remainingAfter = availableCredit - finalAmount;
                    summaryHtml += `<div class="flex justify-between text-base font-bold pt-2 text-teal-700"><span>이번 주문 여신 사용액</span><span>${formatCurrency(finalAmount)}</span></div><div class="flex justify-between text-xs text-gray-500 mt-1"><span>결제 후 잔여 한도</span><span>${formatCurrency(remainingAfter)}</span></div>`;
                } else {
                    summaryHtml += `<div class="flex justify-between text-base font-bold pt-2"><span>최종 결제 금액</span><span class="text-red-600">${formatCurrency(finalAmount)}</span></div>`;
                }
                ui.footerSummary.innerHTML = summaryHtml;
                ui.paymentButton.textContent = `${formatCurrency(finalAmount)} 결제하기`;

            } else {
                ui.paymentSufficient.classList.add('hidden');
                ui.paymentShortfall.classList.remove('hidden');
                
                const shortfall = finalAmount - availableCredit;
                ui.shortfallTotal.textContent = formatCurrency(finalAmount);
                ui.shortfallCreditUsed.textContent = `- ${formatCurrency(availableCredit)}`;
                ui.shortfallAmount.textContent = formatCurrency(shortfall);

                const selectedShortfallPayment = document.querySelector('input[name="shortfall-payment"]:checked').value;
                ui.bankInfo.classList.toggle('show', selectedShortfallPayment === 'vbank' || selectedShortfallPayment === 'bank');
                
                let summaryHtml = `<div class="flex justify-between"><span class="text-gray-600">총 상품금액</span><span>${formatCurrency(orderTotal)}</span></div><div class="flex justify-between"><span class="text-gray-600">배송비</span><span>${formatCurrency(currentShippingFee)}</span></div><hr class="my-2 !m-0">`;
                summaryHtml += `<div class="flex justify-between"><span class="text-gray-600">최종 결제 금액</span><span class="font-bold">${formatCurrency(finalAmount)}</span></div>`;
                summaryHtml += `<div class="flex justify-between text-teal-600"><span class="font-medium">여신 사용</span><span class="font-medium">- ${formatCurrency(availableCredit)}</span></div>`;
                
                // ✨ 개선점: 버튼 텍스트 통일
                if (selectedShortfallPayment === 'vbank' || selectedShortfallPayment === 'bank') {
                    summaryHtml += `<div class="flex justify-between text-orange-800"><span class="font-bold">추가 입금 예정 금액</span><span class="font-bold">${formatCurrency(shortfall)}</span></div>`;
                } else {
                    summaryHtml += `<div class="flex justify-between text-orange-800"><span class="font-bold">추가 결제 금액</span><span class="font-bold">${formatCurrency(shortfall)}</span></div>`;
                }
                ui.paymentButton.textContent = `${formatCurrency(shortfall)} 결제하기`;
                ui.footerSummary.innerHTML = summaryHtml;
            }
        }

        function copyToClipboard() {
            const tempInput = document.createElement('input');
            tempInput.value = bankAccount;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            ui.copyMessage.textContent = '계좌번호가 복사되었습니다.';
            setTimeout(() => { ui.copyMessage.textContent = ''; }, 2000);
        }

        function setupAccordion(buttonId, contentId, startOpen = false, summaryEl = null) {
            const button = document.getElementById(buttonId);
            const content = document.getElementById(contentId);
            let isOpen = startOpen;
            const toggle = () => {
                isOpen = !isOpen;
                if (isOpen) {
                    content.style.maxHeight = content.scrollHeight + 'px';
                    if (summaryEl) summaryEl.style.display = 'none';
                    button.textContent = '숨기기';
                } else {
                    content.style.maxHeight = '0';
                    if (summaryEl) summaryEl.style.display = 'block';
                    button.textContent = '변경';
                }
            };
            if (!startOpen) content.style.maxHeight = '0';
            button.addEventListener('click', toggle);
        }
    </script>
</body>
</html>
