<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이페이지 (최근 주문내역 개선)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .tab-button.active {
            border-bottom: 2px solid #1f2937;
            color: #1f2937;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* 주문 상태별 색상 */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 0.25rem;
        }
        .status-deposit-wait { background-color: #fff7ed; color: #c2410c; }
        .status-delivery-complete { background-color: #f0fdfa; color: #0f766e; }
        .status-complete { background-color: #eef2ff; color: #3730a3; }
        .status-cancel { background-color: #fef2f2; color: #dc2626; }
        .status-order { background-color: #fdf2f8; color: #be185d; }
        .status-deposit-confirm { background-color: #f0fdf4; color: #15803d; }
        .status-delivery-prep { background-color: #fff7ed; color: #c2410c; }

        /* 메인 탭 버튼 크기 조정 */
        .filter-btn {
            padding: 6px 12px;
            font-size: 0.875rem;
            border-radius: 16px;
            border: 1px solid #D1D5DB;
            background-color: #F9FAFB;
            color: #374151;
            transition: all 0.2s;
            flex-shrink: 0; 
            margin-right: 8px;
            position: relative; /* 뱃지 위치를 잡기 위해 relative 추가 */
        }
        .filter-btn:last-child { margin-right: 16px; }
        .filter-btn:hover { background-color: #F3F4F6; }
        .filter-btn.active {
            background-color: #EFF6FF;
            border-color: #BFDBFE;
            color: #1D4ED8;
            font-weight: 500;
        }
        
        /* 기간 필터 스타일 */
        .sub-filter-btn {
            padding: 2px 6px; 
            font-size: 0.8125rem;
            color: #6B7280;
            background-color: transparent;
            border: 0;
            border-bottom: 2px solid transparent; 
            border-radius: 0; 
            margin-right: 8px;
            transition: all 0.2s;
            flex-shrink: 0;
            line-height: 1.5;
        }
        .sub-filter-btn:last-child { margin-right: 0; }
        .sub-filter-btn:hover { color: #374151; }
        .sub-filter-btn.active {
            color: #1D4ED8;
            font-weight: 600;
            border-bottom-color: #1D4ED8;
        }
        
        /* 소계 탭 스타일 */
        .summary-row {
            display: flex;
            align-items: center;
            font-weight: 700;
            border-top: 2px solid #374151;
            background-color: #F3F4F6;
            padding: 12px 4px;
            margin-top: 4px;
        }
        .summary-row .label { width: 25%; text-align: center; font-size: 0.875rem; color: #374151; }
        .summary-row .value { width: 25%; text-align: right; padding: 0 4px; font-size: 0.875rem; }
        
        /* 탭 네비게이션 플렉스 조정 */
        .tab-nav-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .tab-buttons {
            display: flex;
            flex-grow: 1;
            overflow-x: auto;
            white-space: nowrap;
            /* 뱃지가 잘리지 않도록 상단 여백을 4px -> 12px로 넉넉하게 수정 */
            padding-top: 12px; 
            padding-bottom: 4px;
        }

        /* 알림내역 테이블 스타일 수정 */
        .notice-table-header {
            border-top: 2px solid #000; /* 상단 굵은 선 */
            border-bottom: 1px solid #e5e7eb;
            background-color: #f9fafb;
            font-size: 0.875rem;
            font-weight: 700;
            color: #111827;
        }
        .notice-row {
            display: flex;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.8125rem;
            line-height: 1.5;
        }
        .notice-col-date {
            width: 25%;
            text-align: center;
            color: #6b7280; /* 날짜 색상 약간 연하게 */
            font-weight: 500;
            padding: 0 4px;
            padding-top: 2px; /* 날짜와 내용의 시각적 정렬 보정 */
        }
        .notice-col-content {
            width: 75%;
            padding: 0 16px; /* 좌우 여백 */
            text-align: left;
            word-break: keep-all;
        }
        .notice-main-text {
            font-size: 0.875rem; /* 14px */
            font-weight: 700;
            margin-bottom: 2px;
        }
        .notice-sub-text {
            font-size: 0.75rem; /* 12px */
            color: #6B7280; /* gray-500 */
        }

    </style>
</head>
<body class="bg-gray-100">

    <div class="max-w-md mx-auto bg-white min-h-screen">
        
        <!-- 헤더 -->
        <header class="flex justify-between items-center p-4 border-b sticky top-0 bg-white z-10">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            <h1 class="text-lg font-bold">마이페이지</h1>
            <div class="w-6"></div>
        </header>

        <main>
            
            <!-- 프로필 섹션 -->
            <section class="px-4 py-2">
                <div class="flex items-center">
                    <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-500"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    </div>
                    <div class="ml-4">
                        <p class="font-bold text-lg">꽃놀이식당</p>
                        <p class="text-sm text-gray-600 mt-1">경남 창원시 성산구 가양로 34</p>
                        <div class="mt-3 flex items-center space-x-3 text-sm text-slate-600">
                            <a href="#" class="hover:underline">정보수정</a>
                            <span class="text-gray-300">|</span>
                            <a href="#" class="hover:underline">로그아웃</a>
                            <span class="text-gray-300">|</span>
                            <a href="#" class="hover:underline">자주찾는 질문</a>
                            <span class="text-gray-300">|</span>
                            <a href="#" id="notice-link" class="hover:underline relative inline-block">
                                공지사항
                                <span id="notice-badge" class="absolute left-full top-0 -mt-1.5 ml-0.5 flex items-center justify-center bg-red-500 text-white text-[10px] font-bold px-1 rounded-full min-w-[16px] h-[16px] leading-none hidden">N</span>
                            </a>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 계좌 정보 및 탭 네비게이션 카드 -->
            <div class="mx-4 mb-4 p-0 border rounded-lg bg-white shadow-sm">
                <!-- 잔액/결제 관리 -->
                <section class="p-4 pt-3 pb-2"> 
                    <div class="flex items-center justify-end">
                        <div class="flex items-center">
                            <span class="text-sm text-gray-600">입금 계좌:</span>
                            <span id="accountNumber" class="text-xs font-semibold text-gray-800 ml-1 mr-2">농협 302-1586-5706-41 이무철</span>
                        </div>
                        <button id="copyAccountBtn" class="px-3 py-1 bg-gray-200 text-gray-700 text-xs font-semibold rounded hover:bg-gray-300 relative flex-shrink-0">
                            복사
                            <span id="copyMessage" class="absolute left-1/2 -top-8 -translate-x-1/2 bg-gray-700 text-white text-xs px-2 py-1 rounded hidden whitespace-nowrap">복사되었습니다!</span>
                        </button>
                    </div>
                </section>

                <!-- 탭 네비게이션 및 미수금 -->
                <section class="p-4 pt-2 pb-1"> 
                    <div class="tab-nav-container"> 
                        <div class="tab-buttons">
                            <button class="main-tab-btn filter-btn active" data-tab="orders">주문내역</button>
                            <!-- 알림내역 버튼: 뱃지 추가 (relative 클래스는 style에서 이미 적용됨) -->
                            <button class="main-tab-btn filter-btn" data-tab="notifications">
                                알림내역
                                <!-- 숫자 뱃지: 우측 상단에 걸치도록 위치 조정 -->
                                <span id="notification-count-badge" class="absolute -top-1.5 -right-1.5 flex h-4 w-4 items-center justify-center rounded-full bg-red-600 text-[10px] text-white font-bold ring-2 ring-white z-10">1</span>
                            </button>
                            <button class="main-tab-btn filter-btn" data-tab="settlements">정산내역</button>
                        </div>
                        <div id="unpaid-balance-display" class="flex-shrink-0 text-right text-sm font-bold">
                            <span id="unpaid-balance-label" class="text-gray-600 mr-1">미수금:</span>
                            <span id="current-unpaid-amount" class="text-red-600">49,000원</span>
                        </div>
                    </div>
                </section>
                
                <!-- 기간 필터 -->
                <section id="global-filter-section" class="pl-4 pr-4 pt-1 pb-3"> 
                    <div class="flex justify-start overflow-x-auto whitespace-nowrap">
                        <button class="sub-filter-btn active" data-filter="7days">최근 7일</button>
                        <button class="sub-filter-btn" data-filter="currentMonth">당월 내역</button>
                        <button class="sub-filter-btn" data-filter="lastMonth">전월 내역</button>
                        <button class="sub-filter-btn" data-filter="all">전체</button>
                    </div>
                </section>
            </div>

            <!-- 탭 컨텐츠 영역 -->
            <div id="tab-contents" class="p-4 pt-0"> 
                
                <!-- 최근 주문내역 탭 -->
                <div id="orders" class="tab-content active">
                    <div class="sticky top-[61px] z-[9] bg-gray-50 border-b border-gray-200">
                        <div class="flex">
                            <div id="sort-order-date" class="w-1/4 text-center px-1 py-3 text-sm font-semibold text-gray-600 cursor-pointer select-none flex items-center justify-center space-x-1">
                                <span>일자</span>
                                <span id="sort-order-arrow">▼</span>
                            </div>
                            <div class="w-[45%] px-2 py-3 text-sm font-semibold text-gray-600 text-center">
                                판매
                            </div>
                            <div class="w-[30%] px-1 py-3 text-sm font-semibold text-gray-600 text-center">
                                입금
                            </div>
                        </div>
                    </div>
                    <div id="order-list-container"> 
                        <!-- 1. 입금대기 -->
                        <div class="order-item-row border-b py-3 flex items-stretch">
                            <div class="w-1/4 text-center px-1">
                                <p class="text-sm text-gray-700">2025-08-26</p>
                                <div class="mt-1"><span class="status-badge status-deposit-wait">입금대기</span></div>
                            </div>
                            <div class="w-[45%] px-2 text-center">
                                <p class="text-sm text-gray-800 overflow-hidden text-ellipsis whitespace-nowrap">양파 20KG 외 2건</p>
                                <div class="text-xs text-gray-500 mt-1 space-y-0.5">
                                    <p>주문: 51,000원</p>
                                    <p class="hide-if-zero">추가: 0원</p>
                                    <!-- 취소금액 빨간색 적용 -->
                                    <p class="text-red-600 font-medium">취소: -2,000원</p>
                                </div>
                            </div>
                            <div class="w-[30%] px-1 text-xs text-gray-500 flex flex-col justify-between">
                                <div class="space-y-1 text-right">
                                    <p>0원(입금)</p>
                                    <p class="hide-if-zero">0원(포인트(쿠))</p>
                                    <p class="hide-if-zero">0원(환불)</p>
                                </div>
                                <div class="text-right"><p class="font-bold text-red-600">49,000원(잔액)</p></div>
                            </div>
                        </div>

                        <!-- 2. 배송완료 -->
                        <div class="order-item-row border-b py-3 flex items-stretch">
                            <div class="w-1/4 text-center px-1">
                                <p class="text-sm text-gray-700">2025-08-25</p>
                                <div class="mt-1"><span class="status-badge status-delivery-complete">배송완료</span></div>
                            </div>
                            <div class="w-[45%] px-2 text-center">
                                <p class="text-sm text-gray-800 overflow-hidden text-ellipsis whitespace-nowrap">흙쪽파(1kg)단 외 1건</p>
                                <div class="text-xs text-gray-500 mt-1 space-y-0.5">
                                    <p>주문: 32,700원</p>
                                    <!-- 취소금액 빨간색 적용 -->
                                    <p class="text-red-600 font-medium">취소: -4,000원</p>
                                    <!-- 환불액 파란색 유지, '원' -> '+P'로 변경 -->
                                    <p class="text-blue-600 font-medium">환불: +4,000P</p>
                                </div>
                            </div>
                            <div class="w-[30%] px-1 text-xs text-gray-500 flex flex-col justify-between">
                                <div class="space-y-1 text-right">
                                    <p>24,700원(입금)</p>
                                    <p>3,000원(포인트)</p>
                                    <p>5,000원(쿠폰)</p>
                                </div>
                                <div class="text-right"><p class="font-bold text-gray-500">0원(잔액)</p></div>
                            </div>
                        </div>

                        <!-- 3. 배송완료 (추가금액 색상 변경: 주황색) -->
                        <div class="order-item-row border-b py-3 flex items-stretch">
                            <div class="w-1/4 text-center px-1">
                                <p class="text-sm text-gray-700">2025-08-24</p>
                                <div class="mt-1"><span class="status-badge status-delivery-complete">배송완료</span></div>
                            </div>
                            <div class="w-[45%] px-2 text-center">
                                <p class="text-sm text-gray-800 overflow-hidden text-ellipsis whitespace-nowrap">배추_3입망 외 5건</p>
                                <div class="text-xs text-gray-500 mt-1 space-y-0.5">
                                    <p>주문: 16,700원</p>
                                    <!-- 추가금액 주황색(orange-600) 적용 -->
                                    <p class="text-orange-600 font-medium">추가: 3,000원</p>
                                </div>
                            </div>
                            <div class="w-[30%] px-1 text-xs text-gray-500 flex flex-col justify-between">
                                <div class="space-y-1 text-right">
                                    <!-- 입금액을 추가금 포함 총액으로 수정 (16,700 + 3,000) -->
                                    <p>19,700원(입금)</p>
                                </div>
                                <!-- 잔액 0원 처리 -->
                                <div class="text-right"><p class="font-bold text-gray-500">0원(잔액)</p></div>
                            </div>
                        </div>

                        <!-- 4. 배송완료 (추가결제분) -->
                        <div class="order-item-row border-b py-3 flex items-stretch">
                            <div class="w-1/4 text-center px-1">
                                <p class="text-sm text-gray-700">2025-08-23</p>
                                <div class="mt-1"><span class="status-badge status-delivery-complete">배송완료</span></div>
                                <p class="text-xs text-blue-600 mt-1">(추가결제분)</p>
                            </div>
                            <div class="w-[45%] px-2 text-center">
                                <p class="text-sm text-gray-800 overflow-hidden text-ellipsis whitespace-nowrap">엄청나게 긴 상품명입니다. 레이아웃이 깨지지 않아야 합니다.</p>
                                <div class="text-xs text-gray-500 mt-1 space-y-0.5">
                                    <p>주문: 10,000원</p>
                                    <p class="hide-if-zero">추가: 0원</p>
                                </div>
                            </div>
                            <div class="w-[30%] px-1 text-xs text-gray-500 flex flex-col justify-between">
                                <div class="space-y-1 text-right">
                                    <p>10,000원(입금)</p>
                                </div>
                                <div class="text-right"><p class="font-bold text-gray-500">0원(잔액)</p></div>
                            </div>
                        </div>

                        <!-- 5. 주문취소 -->
                        <div class="order-item-row border-b py-3 flex items-stretch text-gray-400">
                            <div class="w-1/4 text-center px-1">
                                <p class="text-sm text-gray-700">2025-08-22</p>
                                <div class="mt-1"><span class="status-badge status-cancel">주문취소</span></div>
                            </div>
                            <div class="w-[45%] px-2 text-center">
                                <p class="text-sm overflow-hidden text-ellipsis whitespace-nowrap">양파 10kg 박스</p>
                                <div class="text-xs mt-1 space-y-0.5">
                                    <p>주문: 41,300원</p>
                                    <!-- 취소금액 명칭 및 색상 통일 -->
                                    <p class="text-red-600 font-medium">취소: -41,300원</p>
                                </div>
                            </div>
                            <div class="w-[30%] px-1 text-xs flex flex-col justify-between">
                                <div class="space-y-1 text-right">
                                    <p>41,300원(입금)</p>
                                    <p class="text-red-500">-41,300원(승인취소)</p>
                                </div>
                                <div class="text-right"><p class="font-bold text-gray-500">0원(잔액)</p></div>
                            </div>
                        </div>
                    </div>
                    <button class="w-full mt-4 text-center p-3 text-sm font-medium text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                        내역 더보기
                    </button>
                </div>
                
                <!-- 알림내역 탭 -->
                <div id="notifications" class="tab-content">
                    
                    <div class="sticky top-[61px] z-[9] notice-table-header">
                        <div class="flex py-3 items-center">
                            <div id="sort-notification-date" class="w-[25%] text-center cursor-pointer select-none flex items-center justify-center space-x-1">
                                <span>일자</span>
                                <span id="sort-notification-arrow" class="text-xs">▼</span>
                            </div>
                            <div class="w-[75%] px-4 text-left">
                                알림 내용
                            </div>
                        </div>
                    </div>

                    <div id="notification-list-container">
                        <div class="notice-row">
                            <div class="notice-col-date">2025-08-25</div>
                            <div class="notice-col-content">
                                <p class="notice-main-text text-blue-600">포인트 +4,000P</p>
                                <p class="notice-sub-text">무우 상박스 결품 포인트 지급</p>
                            </div>
                        </div>

                        <div class="notice-row">
                            <div class="notice-col-date">2025-08-25</div>
                            <div class="notice-col-content">
                                <p class="notice-main-text text-red-600">포인트 -15,000P</p>
                                <p class="notice-sub-text">주문번호 20250826-001 결제</p>
                            </div>
                        </div>

                        <div class="notice-row">
                            <div class="notice-col-date">2025-08-25</div>
                            <div class="notice-col-content">
                                <p class="notice-main-text text-red-600">쿠폰 사용 -10,000원</p>
                                <p class="notice-sub-text">주문번호 20250826-001 결제</p>
                            </div>
                        </div>

                        <div class="notice-row">
                            <div class="notice-col-date">2025-08-24</div>
                            <div class="notice-col-content">
                                <p class="notice-main-text text-gray-800">주문 변경</p>
                                <p class="notice-sub-text">올리브오일 대체 배송으로 인한 추가금 3,000원 발생</p>
                            </div>
                        </div>

                        <div class="notice-row">
                            <div class="notice-col-date">2025-08-20</div>
                            <div class="notice-col-content">
                                <p class="notice-main-text text-gray-800">쿠폰 지급 5,000원</p>
                                <p class="notice-sub-text">
                                    신규 회원가입 축하 쿠폰<br>
                                    (유효기간: ~09.19)
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 정산내역 탭 -->
                <div id="settlements" class="tab-content">
                    <div class="sticky top-[61px] z-[9] bg-gray-50 border-b border-gray-200">
                        <div class="flex">
                            <div id="sort-settlement-date" class="w-1/4 px-1 py-3 text-sm font-semibold text-gray-600 cursor-pointer select-none flex items-center justify-center space-x-1">
                                <span>일자</span>
                                <span id="sort-settlement-arrow">▲</span> 
                            </div>
                            <div class="w-1/4 px-1 py-3 text-sm font-semibold text-gray-600 text-center">판매</div>
                            <div class="w-1/4 px-1 py-3 text-sm font-semibold text-gray-600 text-center">입금</div>
                            <div class="w-1/4 px-1 py-3 text-sm font-semibold text-gray-600 text-center">잔액</div>
                        </div>
                    </div>
                    <div id="settlement-list-container">
                        <div class="border-b py-3 flex items-center text-sm settlement-item" data-date="2025-08-23" data-sales="10000" data-deposit="10000">
                            <div class="w-1/4 text-center px-1 text-gray-700">2025-08-23</div>
                            <div class="w-1/4 px-1 text-right font-medium text-red-600">+10,000</div>
                            <div class="w-1/4 px-1 text-right font-medium text-blue-600">-10,000</div>
                            <div class="w-1/4 px-1 text-right font-bold text-gray-900 balance-amount" data-balance="0">0</div>
                        </div>
                        <div class="border-b py-3 flex items-center text-sm settlement-item" data-date="2025-08-24" data-sales="19700" data-deposit="19700">
                            <div class="w-1/4 text-center px-1 text-gray-700">2025-08-24</div>
                            <div class="w-1/4 px-1 text-right font-medium text-red-600">+19,700</div>
                            <div class="w-1/4 px-1 text-right font-medium text-blue-600">-19,700</div>
                            <div class="w-1/4 px-1 text-right font-bold text-gray-900 balance-amount" data-balance="0">0</div>
                        </div>
                        <div class="border-b py-3 flex items-center text-sm settlement-item" data-date="2025-08-25" data-sales="28700" data-deposit="28700">
                            <div class="w-1/4 text-center px-1 text-gray-700">2025-08-25</div>
                            <div class="w-1/4 px-1 text-right font-medium text-red-600">+28,700</div>
                            <div class="w-1/4 px-1 text-right font-medium text-blue-600">-28,700</div>
                            <div class="w-1/4 px-1 text-right font-bold text-gray-900 balance-amount" data-balance="0">0</div>
                        </div>
                        <div class="border-b py-3 flex items-center text-sm settlement-item" data-date="2025-08-26" data-sales="49000" data-deposit="0">
                            <div class="w-1/4 text-center px-1 text-gray-700">2025-08-26</div>
                            <div class="w-1/4 px-1 text-right font-medium text-red-600">+49,000</div>
                            <div class="w-1/4 px-1 text-right font-medium text-blue-600">0</div>
                            <div class="w-1/4 px-1 text-right font-bold text-red-600 balance-amount" data-balance="49000">49,000</div>
                        </div>
                    </div>
                    <div class="summary-row">
                        <div class="label">소계</div>
                        <div id="summary-sales" class="value text-red-600">0</div> 
                        <div id="summary-deposit" class="value text-blue-600">0</div>
                        <div id="summary-balance" class="value font-extrabold text-red-600">0</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const currencyFormatter = new Intl.NumberFormat('ko-KR');

        function hideZeroValues() {
            const candidates = document.querySelectorAll('.hide-if-zero');
            candidates.forEach(el => {
                if (el.innerText.includes('0원(') || el.innerText.includes(': 0원')) { 
                    el.classList.add('hidden'); 
                } else {
                    el.classList.remove('hidden'); 
                }
            });
        }

        function sortItems(container, itemSelector, dateSelector, direction) {
            if (!container) return; 
            const items = Array.from(container.querySelectorAll(itemSelector));
            items.sort((a, b) => {
                const dateTextA = a.querySelector(dateSelector)?.innerText || '';
                const dateTextB = b.querySelector(dateSelector)?.innerText || '';
                if (direction === 'asc') return dateTextA.localeCompare(dateTextB);
                else return dateTextB.localeCompare(dateTextA);
            });
            items.forEach(item => container.appendChild(item));
        }
        
        function calculateSettlementSummary() {
            const items = document.querySelectorAll('#settlement-list-container .settlement-item');
            let totalSales = 0;
            let totalDeposit = 0;
            let currentBalance = 0; 
            items.forEach(item => {
                const sales = parseInt(item.dataset.sales || 0);
                const deposit = parseInt(item.dataset.deposit || 0);
                totalSales += sales;
                totalDeposit += deposit;
            });
            currentBalance = totalSales - totalDeposit;

            const summarySalesEl = document.getElementById('summary-sales');
            const summaryDepositEl = document.getElementById('summary-deposit');
            const summaryBalanceEl = document.getElementById('summary-balance');

            if (summarySalesEl) summarySalesEl.innerText = currencyFormatter.format(totalSales);
            if (summaryDepositEl) summaryDepositEl.innerText = currencyFormatter.format(totalDeposit);
            
            if (summaryBalanceEl) {
                summaryBalanceEl.innerText = currencyFormatter.format(Math.abs(currentBalance));
                summaryBalanceEl.classList.remove('text-red-600', 'text-blue-600', 'text-gray-900');
                if (currentBalance > 0) summaryBalanceEl.classList.add('text-red-600');
                else if (currentBalance < 0) summaryBalanceEl.classList.add('text-blue-600');
                else summaryBalanceEl.classList.add('text-gray-900');
            }

            const unpaidAmountEl = document.getElementById('current-unpaid-amount');
            const unpaidLabelEl = document.getElementById('unpaid-balance-label');
            if (unpaidAmountEl && unpaidLabelEl) {
                unpaidLabelEl.innerText = '미수금:';
                unpaidAmountEl.classList.add('text-red-600');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const mainTabs = document.querySelectorAll('.main-tab-btn');
            const contents = document.querySelectorAll('.tab-content');

            mainTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    mainTabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    const contentId = tab.dataset.tab;
                    const contentElement = document.getElementById(contentId);
                    if(contentElement) {
                        contentElement.classList.add('active');
                        if (contentId === 'settlements') calculateSettlementSummary();
                    }

                    // [신규] 알림내역 탭 클릭 시 숫자 뱃지 숨기기
                    if (tab.dataset.tab === 'notifications') {
                        const notiBadge = document.getElementById('notification-count-badge');
                        if (notiBadge) {
                            notiBadge.classList.add('hidden');
                        }
                    }
                });
            });

            const copyBtn = document.getElementById('copyAccountBtn');
            const accountSpan = document.getElementById('accountNumber'); 
            const copyMsg = document.getElementById('copyMessage');

            if (copyBtn && accountSpan && copyMsg) {
                copyBtn.addEventListener('click', () => {
                    const accountNumText = accountSpan.innerText; 
                    const tempTextarea = document.createElement('textarea');
                    tempTextarea.value = accountNumText; 
                    document.body.appendChild(tempTextarea);
                    tempTextarea.select();
                    try {
                        document.execCommand('copy');
                        copyMsg.classList.remove('hidden');
                        setTimeout(() => { copyMsg.classList.add('hidden'); }, 1500);
                    } catch (err) { console.error('계좌번호 복사 실패:', err); }
                    document.body.removeChild(tempTextarea);
                });
            }

            const globalFilterSection = document.getElementById('global-filter-section');
            const subFilterButtons = globalFilterSection.querySelectorAll('.sub-filter-btn');

            if (globalFilterSection) {
                subFilterButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        subFilterButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        const activeTabId = document.querySelector('.main-tab-btn.active').dataset.tab;
                        if (activeTabId === 'settlements') calculateSettlementSummary();
                    });
                });
            }

            hideZeroValues();
            calculateSettlementSummary();

            // 주문내역 정렬
            const sortOrderButton = document.getElementById('sort-order-date');
            const sortOrderArrow = document.getElementById('sort-order-arrow');
            const orderContainer = document.getElementById('order-list-container');
            let orderSortDirection = 'desc'; 
            if (sortOrderButton && orderContainer) {
                sortOrderButton.addEventListener('click', () => {
                    orderSortDirection = orderSortDirection === 'desc' ? 'asc' : 'desc';
                    sortOrderArrow.innerText = orderSortDirection === 'desc' ? '▼' : '▲';
                    sortItems(orderContainer, '.order-item-row', '.text-sm.text-gray-700', orderSortDirection);
                });
            }

            // 정산내역 정렬
            const sortSettlementButton = document.getElementById('sort-settlement-date');
            const sortSettlementArrow = document.getElementById('sort-settlement-arrow');
            const settlementContainer = document.getElementById('settlement-list-container');
            let settlementSortDirection = 'asc'; 
            if (sortSettlementButton && settlementContainer) {
                sortSettlementButton.addEventListener('click', () => {
                    settlementSortDirection = settlementSortDirection === 'asc' ? 'desc' : 'asc';
                    sortSettlementArrow.innerText = settlementSortDirection === 'asc' ? '▲' : '▼';
                    sortItems(settlementContainer, '.border-b.py-3', '.text-gray-700', settlementSortDirection);
                });
            }

            // 알림내역 정렬 (수정됨: notice-row 및 notice-col-date 클래스 사용)
            const sortNotificationButton = document.getElementById('sort-notification-date');
            const sortNotificationArrow = document.getElementById('sort-notification-arrow');
            const notificationContainer = document.getElementById('notification-list-container');
            let notificationSortDirection = 'desc'; 

            if (sortNotificationButton && notificationContainer) {
                sortNotificationButton.addEventListener('click', () => {
                    notificationSortDirection = notificationSortDirection === 'desc' ? 'asc' : 'desc';
                    sortNotificationArrow.innerText = notificationSortDirection === 'desc' ? '▼' : '▲';
                    // CSS 클래스 기반 정렬
                    sortItems(notificationContainer, '.notice-row', '.notice-col-date', notificationSortDirection);
                });
            }

            const noticeLink = document.getElementById('notice-link');
            const noticeBadge = document.getElementById('notice-badge');
            const LATEST_NOTICE_ID = 'notice_2025_11_27_update';
            const lastReadNoticeId = localStorage.getItem('lastReadNoticeId');

            if (lastReadNoticeId !== LATEST_NOTICE_ID) {
                if (noticeBadge) noticeBadge.classList.remove('hidden');
            } else {
                if (noticeBadge) noticeBadge.classList.add('hidden');
            }

            if (noticeLink) {
                noticeLink.addEventListener('click', (e) => {
                    if (noticeBadge) noticeBadge.classList.add('hidden');
                    localStorage.setItem('lastReadNoticeId', LATEST_NOTICE_ID);
                });
            }
        });
    </script>
</body>
</html>
